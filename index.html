# --- 5. è®¡ç®—ç»“æœå±•ç¤º ---
if submitted:
    if gross_pay == 0:
        st.warning("âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„åº”å‘åˆè®¡é‡‘é¢")
    else:
        # æ‰§è¡Œè®¡ç®—
        res = calculate_details(month, gross_pay, social_total, special, slip_tax)

        # --- A. é¡¶éƒ¨æ ¸å¿ƒæŒ‡æ ‡ ---
        k1, k2, k3 = st.columns(3)
        k1.metric("å·¥èµ„æ¡æ˜¾ç¤º", f"Â¥ {slip_tax:,.2f}")
        k2.metric("ç³»ç»Ÿè®¡ç®—", f"Â¥ {res['current_tax']:,.2f}")
        k3.metric("å·®é¢", f"Â¥ {res['diff']:+,.2f}", delta_color="inverse")

        # --- B. æ™ºèƒ½å·®å¼‚åˆ†æ ---
        diff = res['diff']
        estimated_special = 0
        if res['rate'] > 0:
            estimated_special = abs(diff) / res['rate']

        if abs(diff) < 1.0:
            st.markdown('<div class="smart-tip-box tip-success"><strong>âœ… å®Œç¾åŒ¹é…ï¼š</strong> æ‚¨çš„å·¥èµ„æ¡ä¸ªç¨è®¡ç®—å®Œå…¨æ­£ç¡®ã€‚</div>', unsafe_allow_html=True)

        elif diff > 10:
             st.markdown(f"""<div class="smart-tip-box tip-warn">
            <strong>ğŸ’¡ æ™ºèƒ½æ¨æ–­ï¼šæ‚¨å¯èƒ½å°‘å¡«äº†ä¸“é¡¹é™„åŠ æ‰£é™¤</strong><br>
            ç³»ç»Ÿè®¡ç®—å€¼ <strong>(Â¥{res['current_tax']:.2f})</strong> é«˜äºå·¥èµ„æ¡ã€‚æ ¹æ®å·®é¢åæ¨ï¼Œæ‚¨å¯èƒ½æ¯æœˆæœ‰çº¦ <strong>Â¥ {estimated_special:,.0f}</strong> çš„ä¸“é¡¹é™„åŠ æ‰£é™¤ã€‚
            </div>""", unsafe_allow_html=True)

        elif diff < -10:
            st.markdown(f"""<div class="smart-tip-box tip-info">
            <strong>ğŸ’¡ æ™ºèƒ½æ¨æ–­ï¼šå‰æœŸæ”¶å…¥æ³¢åŠ¨ æˆ– å¥–é‡‘å½±å“</strong><br>
            ç³»ç»Ÿè®¡ç®—å€¼ <strong>(Â¥{res['current_tax']:.2f})</strong> ä½äºå·¥èµ„æ¡ã€‚è¿™æ„å‘³ç€æ‚¨<strong>å‰ {month-1} ä¸ªæœˆçš„å®é™…å¹³å‡æ”¶å…¥å¯èƒ½é«˜äºæœ¬æœˆ</strong>ï¼Œæˆ–è€…ä¹‹å‰å‘è¿‡å¥–é‡‘ã€‚
            </div>""", unsafe_allow_html=True)

        # --- C. è¯¦ç»†å®¡è®¡è¡¨æ ¼ (å…³é”®ä¿®å¤ï¼šç§»é™¤ç¼©è¿›) ---
        def fmt_money(val):
            sign = "-" if val < 0 else ""
            return f"{sign} Â¥ {abs(val):,.2f}"

        data_rows = [
            ("1", "ç´¯è®¡åº”å‘å·¥èµ„", res['cum_gross'], f"æœˆè–ª {gross_pay:,.2f} Ã— {month}ä¸ªæœˆ", ""),
            ("2", "(-) ç´¯è®¡åŸºæœ¬å‡é™¤", -res['cum_threshold'], f"5000 Ã— {month}ä¸ªæœˆ", "text-red"),
            ("3", "(-) ç´¯è®¡ç¤¾ä¿å…¬ç§¯é‡‘", -res['cum_social'], f"ä¸ªäººæœˆç¼´ {social_total:,.2f} Ã— {month}ä¸ªæœˆ", "text-red"),
            ("4", "(-) ç´¯è®¡ä¸“é¡¹é™„åŠ ", -res['cum_special'], f"ç”³æŠ¥é¢ {special:,.2f} Ã— {month}ä¸ªæœˆ", "text-red"),
            ("5", "(=) ç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢", res['cum_taxable'], "ç´¯è®¡æ”¶å…¥ - ä¸Šè¿°æ‰£é™¤é¡¹", "row-highlight"),
            ("6", "ç´¯è®¡åº”çº³ç¨é¢", res['cum_tax_payable'], f"ç´¯è®¡åŸºæ•° Ã— {res['rate']*100:.0f}% - é€Ÿç®—æ‰£é™¤æ•°{res['quick']}", "row-highlight"),
            ("7", "(-) æ¨¡æ‹Ÿå·²ç¼´ç¨é¢", -res['prev_paid'], f"å‰ {month-1} ä¸ªæœˆä¼°ç®—å·²ç¼´", "text-red"),
            ("8", "(=) æœ¬æœˆåº”è¡¥(é€€)ç¨", res['current_tax'], "ç´¯è®¡åº”çº³ - å·²ç¼´", "row-final"),
        ]

        # ä¿®å¤ç‚¹ï¼šè¿™é‡Œä¸ä½¿ç”¨å¤šè¡Œç¼©è¿›å­—ç¬¦ä¸²ï¼Œé¿å…è¢«è¯†åˆ«ä¸º Markdown ä»£ç å—
        rows_html = ""
        for step, name, val, note, cls in data_rows:
            val_cls = "text-red" if (val < 0 and "row-final" not in cls) else "font-mono"
            if "row-final" in cls: val_cls = "font-mono"

            # ä½¿ç”¨å•è¡Œæ‹¼æ¥ï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•å‰å¯¼ç©ºæ ¼
            rows_html += f'<tr class="{cls}">'
            rows_html += f'<td style="text-align:center; color:#999;">{step}</td>'
            rows_html += f'<td>{name}</td>'
            rows_html += f'<td class="{val_cls} font-mono">{fmt_money(val)}</td>'
            rows_html += f'<td class="text-note">{note}</td>'
            rows_html += '</tr>'

        st.markdown(f"""
<div class="table-container">
<h4 style="margin-top:0; margin-bottom:15px; color:#333;">ğŸ“‹ è®¡ç®—è¿‡ç¨‹æ˜ç»†å•</h4>
<table class="audit-table">
<thead>
<tr>
<th style="width:8%; text-align:center">æ­¥éª¤</th>
<th style="width:25%">é¡¹ç›®åç§°</th>
<th style="width:25%">ç´¯è®¡é‡‘é¢ (å…ƒ)</th>
<th style="width:42%">è®¡ç®—è¿‡ç¨‹ / å…¬å¼å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
{rows_html}
</tbody>
</table>
</div>
""", unsafe_allow_html=True)